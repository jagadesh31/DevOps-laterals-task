package com.example.nittfest

import android.os.Bundle
import androidx.activity.ComponentActivity
import androidx.activity.compose.setContent
import androidx.activity.enableEdgeToEdge
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.material3.MaterialTheme
import androidx.compose.material3.Surface
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.collectAsState
import androidx.compose.runtime.getValue
import androidx.compose.ui.Modifier
import androidx.compose.ui.graphics.Color
import androidx.lifecycle.ViewModel
import androidx.lifecycle.ViewModelProvider
import androidx.lifecycle.viewmodel.compose.viewModel
import androidx.navigation.NavType
import androidx.navigation.compose.NavHost
import androidx.navigation.compose.composable
import androidx.navigation.compose.rememberNavController
import androidx.navigation.navArgument
import com.example.nfapp.ui.screens.cart.CartScreen
import com.example.nfapp.ui.screens.payment.FailureScreen
import com.example.nfapp.ui.screens.payment.PaymentScreen
import com.example.nittfest.session.SessionManager
import com.example.nittfest.data.api.ApiService
import com.example.nittfest.data.api.AuthControllers
import com.example.nittfest.ui.screens.auth.AuthViewModel
import com.example.nittfest.ui.screens.auth.screens.*
import com.example.nittfest.ui.screens.auth.screens.resetPin.*
import com.example.nittfest.ui.screens.auth.screens.resetPassword.*
import com.example.nittfest.ui.components.ToastHost
import com.example.nittfest.ui.context.UserViewModel
import com.example.nittfest.ui.context.MainViewModel
import com.example.nittfest.ui.deliciousfoods.DeliciousFoodsScreen
import com.example.nittfest.ui.screens.events.EventsScreen
import com.example.nittfest.ui.screens.home.HomeScreen
import com.example.nittfest.ui.screens.informals.InformalsScreen
import com.example.nittfest.ui.screens.leaderboard.EventLeaderboardScreen
import com.example.nittfest.ui.screens.leaderboard.LeaderboardScreen
import com.example.nittfest.ui.screens.menu.ShopMenuScreen
import com.example.nittfest.ui.screens.notifications.NotificationsScreen
import com.example.nittfest.ui.screens.profile.ProfileScreen
import com.example.nittfest.ui.screens.proshows.ProshowsScreen
import com.example.nittfest.ui.screens.settings.SettingsScreen
import com.example.nittfest.ui.screens.shops.ShopsScreen
import com.example.nittfest.ui.screens.splash.SplashScreen

import com.example.nittfest.ui.theme.NittFestTheme
import retrofit2.Retrofit
import retrofit2.converter.moshi.MoshiConverterFactory

class MainActivity : ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        enableEdgeToEdge()

        val sessionManager = SessionManager(applicationContext)
        val apiService: ApiService = Retrofit.Builder()
            .baseUrl(BuildConfig.SERVER_URL)
            .addConverterFactory(MoshiConverterFactory.create())
            .build()
            .create(ApiService::class.java)


        val authControllers = AuthControllers(apiService, sessionManager)
        val userViewModelFactory = UserViewModelFactory(authControllers)

        setContent {
            NittFestTheme {
                Surface(
                    modifier = Modifier.fillMaxSize(),
                    color = MaterialTheme.colorScheme.background
                ) {
                    val navController = rememberNavController()
                    val userViewModel: UserViewModel = viewModel(factory = userViewModelFactory)
                    val authViewModel: AuthViewModel = viewModel(factory = userViewModelFactory)
                    val viewModel: ViewModel = viewModel(factory = viewModelFactory)

                    val isAuthenticated by userViewModel.isAuthenticated.collectAsState()
                    val isLoggingOut by userViewModel.isLoggingOut.collectAsState()

                    LaunchedEffect(isAuthenticated, isLoggingOut) {
                        when {
                            isAuthenticated && !isLoggingOut -> {
                                navController.navigate(Screen.Home.route) {
                                    popUpTo(navController.graph.startDestinationId) { inclusive = true }
                                }
                                authViewModel.clearAuthState()
                            }
                            isLoggingOut && !isAuthenticated -> {
                                navController.navigate(Screen.Auth.route) {
                                    popUpTo(navController.graph.startDestinationId) { inclusive = true }
                                }
                                authViewModel.clearAuthState()
                                userViewModel.onLogoutNavigated()
                            }
                        }
                    }

                    Box(modifier = Modifier.fillMaxSize()) {
                        Surface(
                            modifier = Modifier.fillMaxSize(),
                            color = Color(0xFF28282B)
                        ) {
                            NavHost(
                                navController = navController,
                                startDestination = Screen.Splash.route
                            ) {
                                // ========================
                                // AUTHENTICATION SCREENS
                                // ========================
                                composable(Screen.Splash.route) {
                                    SplashScreen(
                                        userViewModel = userViewModel,
                                        navigateToAuth = {
                                            navController.navigate(Screen.Auth.route) {
                                                popUpTo(Screen.Splash.route) { inclusive = true }
                                            }
                                        },
                                        navigateToHome = {
                                            navController.navigate(Screen.Home.route) {
                                                popUpTo(Screen.Splash.route) { inclusive = true }
                                            }
                                        }
                                    )
                                }

                                composable(Screen.Auth.route) {
                                    val authStep by authViewModel.authStep.collectAsState()

                                    when (authStep) {
                                        com.example.nittfest.ui.screens.auth.AuthStep.RollNumber ->
                                            RollNumberScreen(
                                                authViewModel = authViewModel,
                                                userViewModel = userViewModel
                                            )

                                        com.example.nittfest.ui.screens.auth.AuthStep.Otp ->
                                            OtpScreen(
                                                authViewModel = authViewModel,
                                                userViewModel = userViewModel
                                            )

                                        com.example.nittfest.ui.screens.auth.AuthStep.CreatePassword ->
                                            CreatePasswordScreen(
                                                authViewModel = authViewModel,
                                                userViewModel = userViewModel
                                            )

                                        com.example.nittfest.ui.screens.auth.AuthStep.CreatePin ->
                                            CreatePinScreen(
                                                authViewModel = authViewModel,
                                                userViewModel = userViewModel
                                            )

                                        com.example.nittfest.ui.screens.auth.AuthStep.LoginPassword ->
                                            LoginPasswordScreen(
                                                authViewModel = authViewModel,
                                                userViewModel = userViewModel
                                            )

                                        com.example.nittfest.ui.screens.auth.AuthStep.Success ->
                                            SuccessScreen {
                                                userViewModel.handleAuthSuccess()

                                                navController.navigate(Screen.Home.route) {
                                                    popUpTo(Screen.Auth.route) { inclusive = true }
                                                    launchSingleTop = true
                                                }

                                                authViewModel.clearAuthState()
                                            }
                                    }
                                }

                                // ========================
                                // MAIN APP SCREENS (NITT FEST)
                                // ========================
                                composable(Screen.Home.route) {
                                    HomeScreen(
                                        userViewModel = userViewModel,
                                        onCategoryClick = { category ->
                                            val route = when (category) {
                                                "Upcoming Events" -> Screen.Events.route
                                                "Interactive Informals" -> Screen.Informals.route
                                                "Delicious Foods" -> Screen.DeliciousFoods.route
                                                "Shops" -> Screen.Shops.route
                                                "Leaderboard" -> Screen.Leaderboard.route
                                                "Settings" -> Screen.Settings.route
                                                else -> category.lowercase()
                                            }
                                            navController.navigate(route)
                                        },
                                        onProfileClick = { navController.navigate(Screen.Profile.route) },
                                        onNotificationClick = { navController.navigate(Screen.Notifications.route) }
                                    )
                                }

                                composable(Screen.ProShows.route) {
                                    ProshowsScreen(
                                        userViewModel = userViewModel,
                                        onBackClick = { navController.popBackStack() },
                                        onNotificationClick = { navController.navigate(Screen.Notifications.route) }
                                    )
                                }

                                composable(Screen.Events.route) {
                                    EventsScreen(
                                        userViewModel = userViewModel,
                                        onBackClick = { navController.popBackStack() },
                                        onNotificationClick = { navController.navigate(Screen.Notifications.route) }
                                    )
                                }

                                composable(Screen.Informals.route) {
                                    InformalsScreen(
                                        userViewModel = userViewModel,
                                        onBackClick = { navController.popBackStack() },
                                        onNotificationClick = { navController.navigate(Screen.Notifications.route) }
                                    )
                                }

                                composable(Screen.DeliciousFoods.route) {
                                    DeliciousFoodsScreen(
                                        userViewModel = userViewModel,
                                        onBackClick = { navController.popBackStack() },
                                        onNotificationClick = { navController.navigate(Screen.Notifications.route) }
                                    )
                                }

                                // ========================
                                // SHOP & COMMERCE SCREENS
                                // ========================
                                composable(Screen.Shops.route) {
                                    ShopsScreen(
                                        navController = navController,
                                        viewModel = viewModel,
                                        onShopClick = { shop ->
                                            ViewModel.setActiveShop(shop.id)
                                            navController.navigate(Screen.Menu.createRoute(shop.id))
                                        },
                                        onCartClick = {
                                            navController.navigate(Screen.Cart.route)
                                        }
                                    )
                                }

                                composable(Screen.Leaderboard.route) {
                                    LeaderboardScreen(
                                        navController = navController,
                                        viewModel = viewModel
                                    )
                                }

                                composable(
                                    route = Screen.EventLeaderboard.route,
                                    arguments = listOf(
                                        navArgument(NavArgs.EVENT_NAME) { type = NavType.StringType }
                                    )
                                ) { backStackEntry ->
                                    val eventName =
                                        backStackEntry.arguments?.getString(NavArgs.EVENT_NAME).orEmpty()
                                    EventLeaderboardScreen(
                                        navController = navController,
                                        eventName = eventName,
                                        onBack = { navController.popBackStack() }
                                    )
                                }

                                composable(
                                    route = Screen.Menu.route,
                                    arguments = listOf(
                                        navArgument(NavArgs.SHOP_ID) { type = NavType.StringType }
                                    )
                                ) { backStackEntry ->
                                    val shopId =
                                        backStackEntry.arguments?.getString(NavArgs.SHOP_ID).orEmpty()
                                    ShopMenuScreen(
                                        navController = navController,
                                        viewModel = viewModel,
                                        shopId = shopId,
                                        onBack = { navController.popBackStack() },
                                        onCartClick = {
                                            navController.navigate(Screen.Cart.route)
                                        }
                                    )
                                }

                                composable(Screen.Cart.route) {
                                    CartScreen(
                                        navController = navController,
                                        viewModel = viewModel,
                                        onBack = { navController.popBackStack() },
                                        onCheckout = {
                                            val activeShopId = ViewModel.activeShopId.value
                                            val currentShop =
                                                ViewModel.shops.value.find { it.id == activeShopId }

                                            if (activeShopId != null && currentShop != null) {
                                                navController.navigate(
                                                    Screen.Payment.createRoute(
                                                        activeShopId,
                                                        currentShop.name
                                                    )
                                                )
                                            }
                                        }
                                    )
                                }

                                composable(
                                    route = Screen.Payment.route,
                                    arguments = listOf(
                                        navArgument(NavArgs.SHOP_ID) { type = NavType.StringType },
                                        navArgument(NavArgs.SHOP_NAME) { type = NavType.StringType }
                                    )
                                ) { backStackEntry ->
                                    PaymentScreen(
                                        navController = navController,
                                        viewModel = viewModel,
                                        shopId = backStackEntry.arguments?.getString(NavArgs.SHOP_ID)
                                            .orEmpty(),
                                        shopName = backStackEntry.arguments?.getString(NavArgs.SHOP_NAME)
                                            .orEmpty()
                                    )
                                }

                                composable(
                                    route = Screen.Success.route,
                                    arguments = listOf(
                                        navArgument(NavArgs.SHOP_NAME) { type = NavType.StringType }
                                    )
                                ) { backStackEntry ->
                                    SuccessScreen(
                                        navController = navController,
                                        viewModel = viewModel,
                                        shopName = backStackEntry.arguments?.getString(NavArgs.SHOP_NAME)
                                            .orEmpty()
                                    )
                                }

                                composable(Screen.Failure.route) {
                                    FailureScreen(
                                        navController = navController,
                                        viewModel = viewModel
                                    )
                                }

                                // ========================
                                // PROFILE & SETTINGS SCREENS
                                // ========================
                                composable(Screen.ResetPin.route) {
                                    ResetPin_PhoneScreen(
                                        authViewModel = authViewModel,
                                        userViewModel = userViewModel,
                                        onNavigateToOtp = {
                                            navController.navigate(Screen.ResetPin1.route)
                                        },
                                        onBackClick = { navController.popBackStack() }
                                    )
                                }

                                composable(Screen.ResetPin1.route) {
                                    ResetPin_OtpScreen(
                                        authViewModel = authViewModel,
                                        userViewModel = userViewModel,
                                        onNavigateToCreatePin = {
                                            navController.navigate(Screen.ResetPin2.route)
                                        },
                                        onBackClick = { navController.popBackStack() },
                                    )
                                }

                                composable(Screen.ResetPin2.route) {
                                    ResetPin_CreateNewScreen(
                                        authViewModel = authViewModel,
                                        userViewModel = userViewModel,
                                        onBackClick = { navController.popBackStack() },
                                        onNavigateToProfile = { navController.navigate(Screen.Profile.route) },
                                    )
                                }

                                composable(Screen.ResetPassword.route) {
                                    ResetPassword_PhoneScreen(
                                        authViewModel = authViewModel,
                                        userViewModel = userViewModel,
                                        onNavigateToOtp = {
                                            navController.navigate(Screen.ResetPassword1.route)
                                        },
                                        onBackClick = { navController.popBackStack() }
                                    )
                                }

                                composable(Screen.ResetPassword1.route) {
                                    ResetPassword_OtpScreen(
                                        authViewModel = authViewModel,
                                        userViewModel = userViewModel,
                                        onNavigateToCreatePassword = {
                                            navController.navigate(Screen.ResetPassword2.route)
                                        },
                                        onBackClick = { navController.popBackStack() },
                                    )
                                }

                                composable(Screen.ResetPassword2.route) {
                                    ResetPassword_CreateNewScreen(
                                        authViewModel = authViewModel,
                                        userViewModel = userViewModel,
                                        onBackClick = { navController.popBackStack() },
                                        onNavigateToProfile = { navController.navigate(Screen.Profile.route) },
                                    )
                                }

                                composable(Screen.Notifications.route) {
                                    NotificationsScreen(
                                        userViewModel = userViewModel,
                                        onBackClick = { navController.popBackStack() }
                                    )
                                }

                                composable(Screen.Profile.route) {
                                    ProfileScreen(
                                        userViewModel = userViewModel,
                                        onBackClick = { navController.popBackStack() },
                                        onNotificationClick = { navController.navigate(Screen.Notifications.route) },
                                        onResetPinClick = { navController.navigate(Screen.ResetPin.route) }
                                    )
                                }

                                composable(Screen.Settings.route) {
                                    SettingsScreen(
                                        userViewModel = userViewModel,
                                        onBackClick = { navController.popBackStack() },
                                        onNotificationClick = { navController.navigate(Screen.Notifications.route) },
                                        onProfileClick = { navController.navigate(Screen.Profile.route) },
                                        onResetPinClick = { navController.navigate(Screen.ResetPin.route) },
                                        onResetPasswordClick = { navController.navigate(Screen.ResetPassword.route) },
                                        onLogout = { userViewModel.onLogout() }
                                    )
                                }
                            }
                        }

                        // GLOBAL TOAST OVERLAY
                        ToastHost(
                            toasts = userViewModel.toasts.collectAsState().value,
                            onDismiss = userViewModel::dismissToast
                        )
                    }
                }
            }
        }
    }
}

// ===========================
// VIEW MODEL FACTORIES
// ===========================

class UserViewModelFactory(
    private val authControllers: AuthControllers,
) : ViewModelProvider.Factory {

    @Suppress("UNCHECKED_CAST")
    override fun <T : ViewModel> create(modelClass: Class<T>): T {
        return when {
            modelClass.isAssignableFrom(UserViewModel::class.java) ->
                UserViewModel(authControllers) as T
            modelClass.isAssignableFrom(AuthViewModel::class.java) ->
                AuthViewModel(authControllers) as T
            else -> throw IllegalArgumentException("Unknown ViewModel class: ${modelClass.name}")
        }
    }
}

class ViewModelFactory(private val apiService: ApiService) : ViewModelProvider.Factory {
    @Suppress("UNCHECKED_CAST")
    override fun <T : ViewModel> create(modelClass: Class<T>): T {
        return ViewModel(apiService) as T
    }
}

// ===========================
// NAVIGATION MODELS
// ===========================

object NavArgs {
    const val SHOP_ID = "shopId"
    const val SHOP_NAME = "shopName"
    const val EVENT_NAME = "eventName"
}

sealed class Screen(val route: String) {
    // Auth Screens
    object Splash : Screen("splash")
    object Auth : Screen("auth")

    // Main Fest Screens
    object Home : Screen("home")
    object ProShows : Screen("proshows")
    object Events : Screen("events")
    object Informals : Screen("informals")
    object DeliciousFoods : Screen("deliciousfoods")

    // Shop/Commerce Screens
    object Shops : Screen("shops")
    object Cart : Screen("cart")
    object Leaderboard : Screen("leaderboard")

    object EventLeaderboard : Screen("eventLeaderboard/{${NavArgs.EVENT_NAME}}") {
        fun createRoute(name: String) = "eventLeaderboard/$name"
    }

    object Menu : Screen("menu/{${NavArgs.SHOP_ID}}") {
        fun createRoute(id: String) = "menu/$id"
    }

    object Payment : Screen("payment/{${NavArgs.SHOP_ID}}/{${NavArgs.SHOP_NAME}}") {
        fun createRoute(id: String, name: String) = "payment/$id/$name"
    }

    object Success : Screen("success/{${NavArgs.SHOP_NAME}}") {
        fun createRoute(name: String) = "success/$name"
    }

    object Failure : Screen("failure")

    // Profile & Settings
    object ResetPin : Screen("resetPin")
    object ResetPin1 : Screen("resetPin1")
    object ResetPin2 : Screen("resetPin2")
    object ResetPassword : Screen("resetPassword")
    object ResetPassword1 : Screen("resetPassword1")
    object ResetPassword2 : Screen("resetPassword2")
    object Notifications : Screen("notifications")
    object Profile : Screen("profile")
    object Settings : Screen("settings")
}